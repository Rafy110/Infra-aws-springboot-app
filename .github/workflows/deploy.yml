name: Deploy Spring Boot to ECS (Blue/Green)

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

  ECR_REPOSITORY: springboot-app-dev
  ECS_CLUSTER: springboot-app-dev-cluster
  ECS_SERVICE: springboot-app-dev-service

  CODEDEPLOY_APP: springboot-app-dev-codedeploy
  CODEDEPLOY_GROUP: springboot-app-dev-deployment-group

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
    # --------------------
    # 1. Checkout code
    # --------------------
    - uses: actions/checkout@v4

    # --------------------
    # 2. AWS Login (THIS logs you into ECR + ECS + CodeDeploy)
    # --------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # --------------------
    # 3. Login to ECR (token-based, no password needed)
    # --------------------
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # --------------------
    # 4. Build & Push Docker Image
    # --------------------
    - name: Build & Push Docker Image
      working-directory: ./demo
      env:
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

    # --------------------
    # 5. Get current task definition
    # --------------------
    - name: Fetch current task definition
      run: |
        TASK_DEF_ARN=$(aws ecs describe-services \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE \
          --query 'services[0].taskDefinition' \
          --output text)

        aws ecs describe-task-definition \
          --task-definition $TASK_DEF_ARN \
          --query 'taskDefinition' > taskdef.json

    # --------------------
    # 6. Create new task definition with new image
    # --------------------
    - name: Register new task definition
      id: taskdef
      run: |
        IMAGE="${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:${{ github.sha }}"

        jq --arg IMAGE "$IMAGE" \
          '.containerDefinitions[0].image=$IMAGE
           | del(.taskDefinitionArn,.revision,.status,.registeredAt,.registeredBy,.compatibilities,.requiresAttributes)' \
          taskdef.json > new-taskdef.json

        ARN=$(aws ecs register-task-definition \
          --cli-input-json file://new-taskdef.json \
          --query 'taskDefinition.taskDefinitionArn' \
          --output text)

        echo "arn=$ARN" >> $GITHUB_OUTPUT

    # --------------------
    # 7. Create AppSpec file
    # --------------------
    - name: Create AppSpec
      run: |
        cat <<EOF > appspec.yaml
        version: 0.0
        Resources:
          - TargetService:
              Type: AWS::ECS::Service
              Properties:
                TaskDefinition: ${{ steps.taskdef.outputs.arn }}
                LoadBalancerInfo:
                  ContainerName: springboot-app-dev-container
                  ContainerPort: 8080
        EOF

    # --------------------
    # 8. Trigger CodeDeploy (THIS deploys to ECS)
    # --------------------
    - name: Deploy via CodeDeploy
      run: |
        aws deploy create-deployment \
          --application-name $CODEDEPLOY_APP \
          --deployment-group-name $CODEDEPLOY_GROUP \
          --revision "$(jq -n \
            --arg content "$(cat appspec.yaml)" \
            '{revisionType:"AppSpecContent",appSpecContent:{content:$content,contentType:"application/x-yaml"}}')" \
          --region $AWS_REGION
