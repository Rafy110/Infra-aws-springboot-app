image: node:18-alpine

pipelines:
  branches:
    develop:
      - step:
          name: DEV Build and Test
          caches:
            - node
          script:
            - cd $BITBUCKET_CLONE_DIR/app
            - npm ci
            - npm run build
            - npm run lint || true
            - echo "✅ DEV Build successful"
            
      - step:
          name: Build and Push (DEV)
          services:
            - docker
          script:
            - |
              # Install AWS CLI
              apk add --no-cache aws-cli
              
              # Configure AWS for DEV
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
              aws configure set region $AWS_REGION
              
              # ECR details for DEV
              ECR_REGISTRY="588945689572.dkr.ecr.us-east-1.amazonaws.com"
              REPO_NAME="nextjs-app-dev"
              
              # Login to ECR
              aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
              
              # Build and push
              cd $BITBUCKET_CLONE_DIR/app
              docker build -t $REPO_NAME:$BITBUCKET_COMMIT .
              
              # Tag as latest AND commit hash
              docker tag $REPO_NAME:$BITBUCKET_COMMIT $ECR_REGISTRY/$REPO_NAME:latest
              docker tag $REPO_NAME:$BITBUCKET_COMMIT $ECR_REGISTRY/$REPO_NAME:$BITBUCKET_COMMIT
              
              # Push both tags
              docker push $ECR_REGISTRY/$REPO_NAME:latest
              docker push $ECR_REGISTRY/$REPO_NAME:$BITBUCKET_COMMIT
              
              echo "✅ DEV Image pushed with latest tag"
              
      - step:
          name: Deploy to ECS (DEV)
          script:
            - |
              # Install AWS CLI
              apk add --no-cache aws-cli
              
              # Configure AWS for DEV
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
              aws configure set region $AWS_REGION
              
              # Deploy to DEV
              aws ecs update-service \
                --cluster nextjs-app-dev-cluster \
                --service nextjs-app-dev-service \
                --force-new-deployment \
                --region $AWS_REGION
              echo "✅ DEV Deployed"

    master:
      - step:
          name: PROD Build and Test
          caches:
            - node
          script:
            - cd $BITBUCKET_CLONE_DIR/app
            - npm ci
            - npm run build
            - npm run lint || true
            - echo "✅ PROD Build successful"
            
      - step:
          name: Build and Push (PROD)
          services:
            - docker
          script:
            - |
              # Install AWS CLI
              apk add --no-cache aws-cli
              
              # Configure AWS for PROD
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_PROD
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_PROD
              aws configure set region $AWS_REGION_PROD
              
              # ECR details for PROD
              ECR_REGISTRY="588945689572.dkr.ecr.us-east-1.amazonaws.com"
              REPO_NAME="nextjs-app-prod"
              
              # Login to ECR
              aws ecr get-login-password --region $AWS_REGION_PROD | docker login --username AWS --password-stdin $ECR_REGISTRY
              
              # Build and push
              cd $BITBUCKET_CLONE_DIR/app
              docker build -t $REPO_NAME:$BITBUCKET_COMMIT .
              
              # Tag as latest AND commit hash
              docker tag $REPO_NAME:$BITBUCKET_COMMIT $ECR_REGISTRY/$REPO_NAME:latest
              docker tag $REPO_NAME:$BITBUCKET_COMMIT $ECR_REGISTRY/$REPO_NAME:$BITBUCKET_COMMIT
              
              # Push both tags
              docker push $ECR_REGISTRY/$REPO_NAME:latest
              docker push $ECR_REGISTRY/$REPO_NAME:$BITBUCKET_COMMIT
              
              echo "✅ PROD Image pushed with latest tag"
              
      - step:
          name: Deploy to ECS (PROD)
          script:
            - |
              # Install AWS CLI
              apk add --no-cache aws-cli
              
              # Configure AWS for PROD
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_PROD
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_PROD
              aws configure set region $AWS_REGION_PROD
              
              # Deploy to PROD
              aws ecs update-service \
                --cluster nextjs-app-prod-cluster \
                --service nextjs-app-prod-service \
                --force-new-deployment \
                --region $AWS_REGION_PROD
              echo "✅ PROD Deployed"

  custom:
    deploy-dev:
      - step:
          name: Manual Deploy (DEV)
          script:
            - |
              apk add --no-cache aws-cli
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
              aws configure set region $AWS_REGION
              aws ecs update-service --cluster nextjs-app-dev-cluster --service nextjs-app-dev-service --force-new-deployment --region $AWS_REGION
              echo "✅ DEV Deployed"
    
    deploy-prod:
      - step:
          name: Manual Deploy (PROD)
          script:
            - |
              apk add --no-cache aws-cli
              aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_PROD
              aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_PROD
              aws configure set region $AWS_REGION_PROD
              aws ecs update-service --cluster nextjs-app-prod-cluster --service nextjs-app-prod-service --force-new-deployment --region $AWS_REGION_PROD
              echo "✅ PROD Deployed"